{% extends "base.html" %}
{% block title %}Dashboard - SoyUCAB{% endblock %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div class="container mt-4 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">游늵 Dashboard de Gesti칩n</h2>
        <button onclick="generatePDF()" class="btn btn-danger border-2">
            <i class="bi bi-file-earmark-pdf-fill me-2"></i>Descargar PDF
        </button>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 p-2 bg-white rounded shadow-sm" id="reportTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active fw-bold" data-bs-toggle="pill" data-bs-target="#tab1">Popularidad</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#tab2">Actividad</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#tab3">Docencia</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#tab4">Antig칲edad</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#tab5">Tutor칤as</button></li>
        <li class="nav-item"><button class="nav-link fw-bold" data-bs-toggle="pill" data-bs-target="#tab6">Calendario</button></li>
    </ul>

    <div class="tab-content" id="report-container">
        
        <div class="tab-pane fade show active" id="tab1">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between">
                    <h5 class="mb-0 fw-bold">Ranking de Popularidad de Grupos</h5>
                </div>
                <div class="card-body">
                    <table class="table align-middle">
                        <thead class="table-light"><tr><th>Grupo</th><th>Miembros</th><th>Popularidad Global</th></tr></thead>
                        <tbody>
                            {% for r in rep1 %}
                            <tr>
                                <td class="fw-bold">{{ r[0] }}</td>
                                <td>{{ r[1] }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                            <div class="progress-bar" style="width: {{ r[2] }}%"></div>
                                        </div>
                                        <span class="small fw-bold">{{ r[2] }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab2">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0 fw-bold">Grupos M치s Activos</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead class="table-light"><tr><th>Grupo</th><th>Eventos</th><th>Estatus</th></tr></thead>
                        <tbody>
                            {% for r in rep2 %}
                            <tr>
                                <td>{{ r[0] }}</td>
                                <td class="fw-bold">{{ r[1] }}</td>
                                <td>
                                    {% if r[2] == 'Muy Activo' %}<span class="badge bg-success">Muy Activo</span>
                                    {% elif r[2] == 'Regular' %}<span class="badge bg-warning text-dark">Regular</span>
                                    {% else %}<span class="badge bg-secondary">Inactivo</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0 fw-bold">Carga Acad칠mica en Eventos</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead class="table-light"><tr><th>Docente</th><th class="text-center">Eventos</th><th class="text-end">Horas Dictadas</th></tr></thead>
                        <tbody>
                            {% for r in rep3 %}
                            <tr>
                                <td>{{ r[0] }}</td>
                                <td class="text-center">{{ r[1] }}</td>
                                <td class="text-end fw-bold text-info">{{ r[2]|round(1) }} hrs</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0 fw-bold">Personal con Mayor Trayectoria</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead><tr><th>Nombre</th><th>Cargo</th><th>Ingreso</th><th>Antig칲edad</th></tr></thead>
                        <tbody>
                            {% for r in rep4 %}
                            <tr>
                                <td class="fw-bold">{{ r[0] }}</td>
                                <td>{{ r[1] }}</td>
                                <td>{{ r[2].strftime('%d/%m/%Y') }}</td>
                                <td class="fw-bold text-primary">{{ r[3]|int }} A침os</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab5">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0 fw-bold">Egresados Tutores de Excelencia</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for r in rep5 %}
                        <div class="col-md-4 mb-3">
                            <div class="border rounded p-3 text-center bg-light">
                                <h6 class="fw-bold text-dark">{{ r[0] }}</h6>
                                <div class="text-muted small mb-2">Tutor desde {{ r[2].strftime('%Y') }}</div>
                                <span class="badge bg-warning text-dark border border-dark">Promedio: {{ r[1] }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="col-12 text-center text-muted">No hay datos suficientes.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0 fw-bold">Estado de Eventos P칰blicos</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-dark"><tr><th>Evento</th><th>Lugar</th><th>Fecha</th><th>Estado</th></tr></thead>
                        <tbody>
                            {% for r in rep6 %}
                            <tr>
                                <td class="ps-4 fw-bold">{{ r[0] }}</td>
                                <td>{{ r[1] }}</td>
                                <td>{{ r[2].strftime('%d/%m/%Y %H:%M') }}</td>
                                <td>
                                    {% if r[3] == 'publicado' %}<span class="badge bg-success">Publicado</span>
                                    {% elif r[3] == 'finalizado' %}<span class="badge bg-secondary">Finalizado</span>
                                    {% else %}<span class="badge bg-warning text-dark">{{ r[3] }}</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
function generatePDF() {
    // 1. Identificar la pesta침a activa para imprimir SOLO eso
    const activeTab = document.querySelector('.tab-pane.active');
    
    if (!activeTab) {
        alert("Por favor selecciona un reporte.");
        return;
    }

    // 2. Configuraci칩n de la "Herramienta de Reportes"
    const opt = {
        margin:       1,
        filename:     'Reporte_Gestion_SoyUCAB.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    // 3. Agregar encabezado temporal para el PDF
    const content = document.createElement('div');
    content.innerHTML = `
        <div style="padding: 20px; text-align: center;">
            <h2 style="color: #004481;">SoyUCAB - Reporte Oficial</h2>
            <p style="color: #666;">Generado el: ${new Date().toLocaleDateString()}</p>
            <hr>
        </div>
    ` + activeTab.innerHTML;

    // 4. Generar y Descargar
    html2pdf().set(opt).from(content).save();
}
</script>
{% endblock %}